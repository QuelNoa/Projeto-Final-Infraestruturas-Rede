apiVersion: v1
kind: Service
metadata:
  name: api
  namespace: resilience
spec:
  selector:
    app: api
  ports:
    - protocol: TCP
      port: 80
      targetPort: 8000
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  name: auth
  namespace: resilience
spec:
  selector:
    app: auth
  ports:
    - protocol: TCP
      port: 8000
      targetPort: 8000
  type: ClusterIP
---
apiVersion: v1
kind: Service
metadata:
  name: dashboard
  namespace: resilience
spec:
  selector:
    app: dashboard
  ports:
    - protocol: TCP
      [cite_start]port: 80         # O Ingress liga-se aqui 
      [cite_start]targetPort: 8000 # O Pod ouve aqui [cite: 12]
      #port: 80
      #$targetPort: 8000
  type: ClusterIP
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: api
  namespace: resilience
spec:
  replicas: 3
  selector:
    matchLabels:
      app: api
  template:
    metadata:
      labels:
        app: api
        tier: app
    spec:
      securityContext:
        runAsNonRoot: true
        seccompProfile:
          type: RuntimeDefault
      containers:
        - name: api
          image: rsl/api:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8000
          env:
            - name: AUTH_URL
              value: "https://auth:8000/validate"
            - name: AUTH_CA_FILE
              value: "/etc/resilience-ca/ca.crt"
            - name: AUTH_TOKEN
              value: "secreto123"
          resources:
            requests:
              cpu: "150m"
              memory: "128Mi"
            limits:
              cpu: "600m"
              memory: "256Mi"
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop: ["ALL"]
          volumeMounts:
            - name: tmp
              mountPath: /tmp
            - name: ca
              mountPath: /etc/resilience-ca
              readOnly: true
          readinessProbe:
            httpGet:
              path: /health
              port: 8000
              scheme: HTTP
            initialDelaySeconds: 4
            periodSeconds: 5
            timeoutSeconds: 1
          livenessProbe:
            httpGet:
              path: /health
              port: 8000
              scheme: HTTP
            initialDelaySeconds: 15
            periodSeconds: 10
            timeoutSeconds: 1
      volumes:
        - name: tmp
          emptyDir: {}
        - name: ca
          secret:
            secretName: resilience-root-ca-secret
            items:
              - key: tls.crt
                path: ca.crt
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: auth
  namespace: resilience
spec:
  replicas: 3
  selector:
    matchLabels:
      app: auth
  template:
    metadata:
      labels:
        app: auth
        tier: app
    spec:
      securityContext:
        runAsNonRoot: true
        seccompProfile:
          type: RuntimeDefault
      containers:
        - name: auth
          image: rsl/auth:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8000
          command: ["uvicorn"]
          args:
            - "src.main:app"
            - "--host"
            - "0.0.0.0"
            - "--port"
            - "8000"
            - "--ssl-certfile"
            - "/etc/auth-tls/tls.crt"
            - "--ssl-keyfile"
            - "/etc/auth-tls/tls.key"
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop: ["ALL"]
          volumeMounts:
            - name: tmp
              mountPath: /tmp
            - name: auth-tls
              mountPath: /etc/auth-tls
              readOnly: true
          readinessProbe:
            httpGet:
              path: /health
              port: 8000
              scheme: HTTPS
            initialDelaySeconds: 4
            periodSeconds: 6
            timeoutSeconds: 2
          livenessProbe:
            httpGet:
              path: /health
              port: 8000
              scheme: HTTPS
            initialDelaySeconds: 15
            periodSeconds: 10
            timeoutSeconds: 2
      volumes:
        - name: tmp
          emptyDir: {}
        - name: auth-tls
          secret:
            secretName: auth-internal-tls-secret
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dashboard
  namespace: resilience
spec:
  replicas: 3
  selector:
    matchLabels:
      app: dashboard
  template:
    metadata:
      labels:
        app: dashboard
        tier: app
    spec:
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        seccompProfile:
          type: RuntimeDefault
      containers:
        - name: dashboard
          image: rsl/dashboard:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8000
          env:
            - name: API_PUBLIC
              value: "https://api.resilience.local"
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop: ["ALL"]
          volumeMounts:
            - name: tmp
              mountPath: /tmp
          readinessProbe:
            httpGet:
              path: /health
              port: 8000
              scheme: HTTP
            initialDelaySeconds: 4
            periodSeconds: 6
            timeoutSeconds: 1
          livenessProbe:
            httpGet:
              path: /health
              port: 8000
              scheme: HTTP
            initialDelaySeconds: 15
            periodSeconds: 10
            timeoutSeconds: 1
      volumes:
        - name: tmp
          emptyDir: {}
